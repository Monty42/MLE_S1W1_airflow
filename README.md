# Вебинар "Создание Airflow DAG разными способами"
## Курс "Инженер машинного обучения", Яндекс Практикум

#### Описание проекта
Подготовка данных для последуещего применения в моделях машинного обучения.
1. Рассмотрим EDA для данных Всемирного банка (World Bank)
2. Реализуем ETL-пайплайна этих данных
3. Создадим первый DAG для получившегося ETL-пайплайна
4. Попрактикуемся
5. Создадим альтернативную реализацию DAG


#### Как работать с проектом?

##### 1. Скачивание и установка зависимостей
1. Чтобы редактировать репозиторий, необходимо сделать его копию. Это делается по кнопке fork.

2. Клонируем репозиторий на свой компьютер:
~~~
git clone <адрес вашей копии репозитория>
~~~

3. Создаём новую ветку:
~~~
git checkout -b <имя новой ветки>
~~~

4. Установка нужных библиотек и окружения:
~~~
python -m venv <имя папки для хранения окружения>
source <имя папки для хранения окружения>/bin/activate
python -m pip install --upgrade pip
pip install -r requirements.txt
pip install -e .
~~~

5. Готово! Можно проверить работоспособность окружения.


##### 2. Задание для самостоятельного выполнения
В ходе самостоятельной работы вам необходимо модифицировать имеющийся DAG:

1. Необходимо добавить в выходную таблицу данные изменения численности и доступность электроэнергии для населения как доволнительные фичи:
    - `s1w1_electricity_access_percent` - таблица "доступность электроэнергии для населения" в базе `source`
    - `s1w1_rural_population_percent` - таблица "изменения численности" в базе `source`

2. Преобразуйте данные стоимости проекта `totalamt` в числовой формат данных.

3. Измените схему финальной таблицы в соответствии с добавленными полями

4. Измените параметры запуска таким образом, чтобы весь пайплайн мог завершиться с ошибкой не более 3 раз (не забудьте про периоды перезапуска)

5. Сделайте скриншот выполнения DAG в Airflow и скриншот выходной таблицы. Добавьте скриншоты в корень проекта (или создайте кастомную папочку).

6. Сделайте pull request в master и скиньте на него ссылку в чат.

В качестве дополнительного задания:

1. Реализуйте `TelegramOperator` для оповещений.


##### 3. Шпаргалка для работы с гитом
1. Добавляем изменения в индекс:
~~~
git add .
~~~

2. Создаём коммит:
~~~
git commit -m "Описание того, что было изменено"
~~~

3. Отправляем изменения в удалённый репозиторий:
~~~
git push
~~~
Если вы локально создали новую ветку, эта команда не сработает, но git сам подскажет, как её модернизировать, чтобы добавить ветку. Можно просто скопировать :)

##### 4. Шпаргалка для запуска Airflow
Скачайте официальный образ сервисов Airflow
~~~
curl -LfO https://airflow.apache.org/docs/apache-airflow/2.7.3/docker-compose.yaml
~~~
Если у вас не инициализированы папки для работы Airflow, выполните следующую команду в терминале:
~~~
mkdir -p ./dags ./logs ./plugins ./config
~~~
Добавьте информацию о вашем `AIRFLOW_UID` в файл `.env`
~~~
echo -e "\nAIRFLOW_UID=$(id -u)" >> .env
~~~
Следующая команда создаст учетную запись с логином и паролем Airflow для веб-интерфйса
~~~
docker compose up airflow-init
~~~
Отчистим кэш
~~~
docker compose down --volumes --remove-orphans
~~~
Начнем сборку образа с всеми параметрами
~~~
docker compose up --build
~~~

#### Архитектура проекта
==============================

    ├── LICENSE         
    ├── README.md          
    ├── data               <- Папка c локальными данными
    │
    ├── notebooks          <- Ноутбук с разведочным анализом данных
    │
    ├── configs            <- Конфиги для работы с Airflow
    │
    ├── logs               <- Логи выполнения задач Airflow
    │
    ├── requirements.txt   <- Файл с зависимостями
    │
    ├── dags               <- Здесь будут лежать ваши DAG
    │
    ├── plugins   <- Код веб-приложения для онлайн-использования модели
    │   ├── app.py         <- Точка входа: обработчики запросов и валидация
    │   │
    │   ├── script.py      <- Скрипт для создания post-запросов 
    │   |
    │   ├── tests.py       <- Юнит-тесты для проверки работы приложения
    │   │
    │   └── steps 
    │       ├── __init__.py    <- Необходимо для восприятия директории как модуля Python  
    │       └── wb_data.py     <- Необходимые шаги, которые будут использоваться в реализации альтернативного DAG
    │
    ├── wb_data.py         <- Код запуска ETL-пайплайна
    │
    ├── .env_template      <- Файл с параметрами вашего окружения. Необходимо создать файл `.env` или переименовать этот файл и добавить в него свои параметры.
    │
    └── Dockerfile         <- Код запуска контейнера с Airflow             

-----------------
